<html dir='ltr' lang='en'>

<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1.0, interactive-widget=resizes-visual' />
  <title>Spud life TEST 3</title>
  <style>
    .container {
      display: grid;
      width: 100%;
      height: 100%;
      outline: 1px solid red;
    }

    .sprite {
      position: absolute;
      outline: 1px solid red;
      background: wheat;
    }

    .player {
      background-color: white;
    }

    .control {
      background-color: cornflowerblue;
      color:white;
    }
  </style>
  <script>

    let itemNumber = 0;
    let qty = 10;
    let sprite = { width: 50, height: 50 };
    let containerBox = null;
    let playerId = 0;
    let distanceY = 10;
    let distanceX = 10;
    let grid = { x: 10, y: 10 };
    // what is this!?! 
    let scale = 5;
    let timers = { duration: 50 };


    document.addEventListener("DOMContentLoaded", function () {
      setContainerBox();
      addSprites();
      addPlayer();
      addControls();
    });

    function setContainerBox() {
      let containerElement = document.querySelector(".container");
      containerBox = containerElement.getBoundingClientRect();
      setSpriteSize();
    }

    function addControls() {
      let controlId = addSprite(1, containerBox.height - (sprite.height * 5), '', sprite.width, sprite.height, 'control');
      let controlElement = document.querySelector(`#i${controlId}`);
      controlElement.onmousedown = function () { moveLeft(); };
      controlElement.onmouseup = function () { clearInterval(timers.moveLeft); timers.moving = false; };
      controlElement.addEventListener("touchstart", moveLeft, false);
      controlElement.addEventListener("touchend", function () { clearInterval(timers.moveLeft); timers.moving = false; }, false);

      let controlId2 = addSprite(sprite.width, containerBox.height - (sprite.height * 5), '', sprite.width, sprite.height, 'control');
      let controlElement2 = document.querySelector(`#i${controlId2}`);
      controlElement2.onmousedown = function () { moveDown();};
      controlElement2.onmouseup = function () { clearInterval(timers.moveDown); timers.moving = false;  };
      controlElement2.addEventListener("touchstart", moveDown, false);
      controlElement2.addEventListener("touchend", function () { clearInterval(timers.moveDown); timers.moving = false; }, false);

      let controlId3 = addSprite(sprite.width, containerBox.height - (sprite.height * 6), '', sprite.width, sprite.height, 'control');
      let controlElement3 = document.querySelector(`#i${controlId3}`);
      controlElement3.onmousedown = function () { moveUp(); };
      controlElement3.onmouseup = function () { clearInterval(timers.moveUp);timers.moving = false; };
      controlElement3.addEventListener("touchstart", moveUp, false);
      controlElement3.addEventListener("touchend", function () { clearInterval(timers.moveUp); timers.moving = false; }, false);

      let controlId4 = addSprite((sprite.width * 2), containerBox.height - (sprite.height * 5), '', sprite.width, sprite.height, 'control');
      let controlElement4 = document.querySelector(`#i${controlId4}`);
      controlElement4.onmousedown = function () { moveRight();  };
      controlElement4.onmouseup = function () { clearInterval(timers.moveRight); timers.moving = false;};
      controlElement4.addEventListener("touchstart", moveRight, false);
      controlElement4.addEventListener("touchend", function () { clearInterval(timers.moveRight); timers.moving = false; }, false);
    }

    function addPlayer() {
      playerId = addSprite(1, 1, 'P', sprite.width, sprite.height, 'player');
    }

    function getPlayerSprite() {
      return document.querySelector(`#i${playerId}`);
    }

    function clearBody() {
      let bodyElement = document.querySelector("body");
      bodyElement.innerHTML = '<div class="container"></dv>';
    }

    function addRandom() {
      clearBody();
      for (let step = 0; step < qty; step++) {
        let x = rnd(containerBox.width - sprite.width);
        let y = rnd(containerBox.height - sprite.height);
        addSprite(x, y, ``, sprite.width, sprite.height);
      }
    }

    // adds a grid with no overlaps
    function addSprites() {
      clearBody();
      let step = { x: 0, y: 0 };
      for (step.y = 0; step.y < grid.y; step.y++) {
        let y = sprite.height * step.y;
        for (step.x = 0; step.x < grid.x; step.x++) {
          let x = sprite.width * step.x;
          addSprite(x, y, ``, sprite.width, sprite.height);
        }
      }
    }

    window.addEventListener("resize", (event) => {
      let last = {
        width: containerBox.width,
        height: containerBox.height
      }
      setContainerBox();
      //
      let newWidthPct = (containerBox.width - last.width) / 100;
      let newHeightPct = (containerBox.height - last.height) / 100;

      console.log(last, newWidthPct, newHeightPct);

      resizeSprites(newWidthPct, newHeightPct);
    });

    function resizeSprites(newWidthPct, newHeightPct) {
      let spritesList = document.querySelectorAll('.sprite');
      spritesList.forEach(element => {
        let elementBox = element.getBoundingClientRect();
        let newLeft = elementBox.left + ((elementBox.left * newWidthPct) / scale);
        let newTop = elementBox.top + ((elementBox.top * newHeightPct) / scale);

        element.style.left = `${newLeft}px`;
        element.style.top = `${newTop}px`;
        element.style.width = `${sprite.width}px`;
        element.style.height = `${sprite.height}px`
      });
    }

    function setSpriteSize() {
      sprite.width = containerBox.width / 10;
      sprite.height = containerBox.height / 10;
      // make sure its square..
      if (sprite.height > sprite.width) {
        sprite.height = sprite.width;
      } else {
        sprite.width = sprite.height;
      }
      grid.x = parseInt(containerBox.width / sprite.width);
      grid.y = parseInt(containerBox.height / sprite.height);
    }

    function rnd(max) {
      return Math.floor(Math.random() * max);
    }

    document.addEventListener("keydown", (event) => {
      if (event.code == 'ArrowUp') {
        moveUp();
      }
      if (event.code == 'ArrowDown') {
        moveDown();
      }
      if (event.code == 'ArrowLeft') {
        moveLeft();
      }
      if (event.code == 'ArrowRight') {
        moveRight();
      }
    });

    document.addEventListener("keyup", (event) => {
      if (event.code == 'ArrowUp') {
        clearInterval(timers.moveUp);
        timers.moving = false;
      }
      if (event.code == 'ArrowDown') {
        clearInterval(timers.moveDown);
        timers.moving = false;
      }
      if (event.code == 'ArrowLeft') {
        clearInterval(timers.moveLeft);
        timers.moving = false;
      }
      if (event.code == 'ArrowRight') {
        clearInterval(timers.moveRight);
        timers.moving = false;
      }
    });

    function moveUp() {
      if (!timers.moving) {
        timers.moveUp = setInterval(() => {
          let playerSprite = getPlayerSprite();
          let playerBox = playerSprite.getBoundingClientRect();
          let newTop = playerBox.top - distanceY;
          if (newTop > 0) {
            playerSprite.style.top = `${newTop}px`;
          }
          timers.moving = true;
        }, timers.duration);
      }
    }

    function moveDown() {
      if (!timers.moving) {
        timers.moveDown = setInterval(() => {
          let playerSprite = getPlayerSprite();
          let playerBox = playerSprite.getBoundingClientRect();
          let newTop = playerBox.top + distanceY;
          if (newTop < containerBox.height - sprite.height) {
            playerSprite.style.top = `${newTop}px`;
          }
          timers.moving = true;
        }, timers.duration);
      }
    }

    function moveLeft() {
      if (!timers.moving) {
        timers.moveLeft = setInterval(() => {
          let playerSprite = getPlayerSprite();
          let playerBox = playerSprite.getBoundingClientRect();
          let newLeft = playerBox.left - distanceX;
          if (newLeft > 0) {
            playerSprite.style.left = `${newLeft}px`;
          }
          timers.moving = true;
        }, timers.duration);
      }
    }

    function moveRight() {
      if (!timers.moving) {
        timers.moveRight = setInterval(() => {
          let playerSprite = getPlayerSprite();
          let playerBox = playerSprite.getBoundingClientRect();
          let newLeft = playerBox.left + distanceX;
          if (newLeft < containerBox.width - sprite.width) {
            playerSprite.style.left = `${newLeft}px`;
          }
          timers.moving = true;
        }, timers.duration);
      }
    }

    function addSprite(x, y, content, w, h, classList = '') {
      itemNumber++;
      let width = `${w}px`;
      let height = `${h}px`;
      let top = `${y}px`;
      let left = `${x}px`;
      let style = `width: ${width}; height:${height}; top:${top}; left:${left};`;
      let newSprite = `<div id="i${itemNumber}" class="sprite ${classList}" style="${style}">${content}</div>`;
      let bodyElement = document.querySelector("body");
      bodyElement.insertAdjacentHTML('beforeend', newSprite);
      return itemNumber;
    }

  </script>
</head>

<body style="margin: 0">
  <div class="container"></div>
</body>

</html>